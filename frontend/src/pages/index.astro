---
import ContactHome from "@/components/home/ContactHome.astro";
import Layout from "../layouts/Layout.astro";
import { getHomePageData } from "@/lib/data";
import FeatureGrid from "@/components/home/FeatureGrid.astro";
import StatsSection from "@/components/home/StatsSection.astro";
import ServiceSection from "@/components/home/ServiceSection.astro";
import Hero from "@/components/home/Hero.astro";
import Newsletter from "@/components/blocks/Newsletter.astro";
import type {
  FeatureGridBlock,
  StatsSectionBlock,
  ServiceSectionBlock,
  LogoSliderBlock,
  HeroBlock,
  NewsletterBlock,
} from "../types/index";
import LogoSlider from "@/components/home/LogoSlider.astro";
import Advice from "@/components/common/Advice.astro";

const { blocks } = await getHomePageData();

// 1. EXTRAER EL NEWSLETTER: Buscamos si existe el bloque en la data
const newsletterData = blocks?.find(
  (b) => b.__component === "blocks.newsletter"
) as NewsletterBlock | undefined;

// 2. FILTRAR EL CONTENIDO: Quitamos el newsletter del array principal para que no salga duplicado arriba
const contentBlocks = blocks?.filter(
  (b) => b.__component !== "blocks.newsletter"
);
---

<Layout>
  {/* Renderizamos el resto de bloques (Hero, Features, etc.) */}
  {
    contentBlocks?.map((block) => {
      if (block.__component === "blocks.hero") {
        return <Hero {...(block as HeroBlock)} />;
      }
      if (block.__component === "blocks.feature-grid") {
        return <FeatureGrid {...(block as FeatureGridBlock)} />;
      }
      if (block.__component === "blocks.stats-section") {
        return <StatsSection {...(block as StatsSectionBlock)} />;
      }
      if (block.__component === "blocks.service-section") {
        return <ServiceSection {...(block as ServiceSectionBlock)} />;
      }
      if (block.__component === "blocks.logo-slider") {
        return <LogoSlider {...(block as LogoSliderBlock)} />;
      }

      // El newsletter ya no está aquí, así que no necesitamos el if

      return process.env.NODE_ENV === "development" ? (
        <div class="p-4 bg-red-100 text-red-700 border border-red-400 m-4 rounded">
          Bloque desconocido: {block["__component"]}
        </div>
      ) : null;
    })
  }

  <ContactHome />

  <Advice />

  {
    newsletterData && (
      <div class="relative z-10 -mt-24 mb-10">
        <Newsletter {...newsletterData} />
      </div>
    )
  }
</Layout>
