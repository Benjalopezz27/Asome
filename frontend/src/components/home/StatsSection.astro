---
import RightArrowIcon from "../shared/icons/rightArrowIcon.astro";

// src/components/blocks/StatsSection.astro

interface Stat {
  id: number;
  number: number;
  suffix?: string;
  label: string;
}

interface Props {
  title: string;
  description: string;
  stats: Stat[];
  buttonText?: string;
  buttonUrl?: string;
}

const { title, description, stats, buttonText, buttonUrl } = Astro.props;
---

<section id="stats-section" class="py-20 bg-dark-blue text-white text-center">
  <div class="max-w-6xl mx-auto px-4">
    <h2 class="text-3xl md:text-4xl font-extrabold mb-6 leading-tight">
      {title}
    </h2>
    <p class="text-gray-300 max-w-2xl mx-auto mb-16 text-lg">
      {description}
    </p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
      {
        stats.map((stat) => (
          <div class="bg-white dark-blue rounded-2xl p-8 shadow-lg transform hover:-translate-y-1 transition-transform duration-300">
            <div class="font-extrabold text-5xl md:text-6xl mb-2 flex justify-center items-center primary-blue">
              <span>{stat.suffix}</span>
              {/* Agregamos una clase única para asegurar la selección */}
              <span class="stats-counter" data-target={stat.number}>
                0
              </span>
            </div>
            <p class="text-xl font-medium text-gray-600">{stat.label}</p>
          </div>
        ))
      }
    </div>

    {
      buttonText && (
        <a
          href={buttonUrl || "#"}
          class="inline-flex items-center gap-2 bg-primary-blue hover:bg text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300"
        >
          {buttonText}
          <RightArrowIcon class="stroke-2" />
        </a>
      )
    }
  </div>
</section>

<script>
  // Definimos la función de inicialización para poder llamarla varias veces si es necesario
  function initStatsAnimation() {
    const section = document.getElementById("stats-section");
    const counters = document.querySelectorAll(".stats-counter");

    // Debug: Verifica en la consola si encuentra los elementos
    if (!section) {
      // console.log("StatsSection: No se encontró la sección #stats-section");
      return;
    }

    // console.log("StatsSection: Inicializando observador...");

    let started = false; // Flag para evitar repeticiones

    const animateCounter = (counter: Element) => {
      const targetAttr = counter.getAttribute("data-target");
      if (!targetAttr) return;

      const target = +targetAttr;
      const duration = 2000;
      const increment = target / (duration / 16);

      let current = 0;

      const updateCount = () => {
        current += increment;
        if (current < target) {
          // Math.ceil asegura que números pequeños suban al menos de 1 en 1
          (counter as HTMLElement).innerText = Math.ceil(current).toString();
          requestAnimationFrame(updateCount);
        } else {
          (counter as HTMLElement).innerText = target.toString();
        }
      };

      updateCount();
    };

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && !started) {
            // console.log("StatsSection: Sección visible, iniciando animación.");
            counters.forEach((counter) => animateCounter(counter));
            started = true;
            observer.disconnect(); // Dejar de observar una vez animado
          }
        });
      },
      { threshold: 0.2 }
    ); // Se activa al ver el 20% del componente

    observer.observe(section);
  }

  // EJECUCIÓN:
  // 1. Ejecutar inmediatamente (para carga normal)
  initStatsAnimation();

  // 2. Ejecutar en cada navegación (Soporte para Astro View Transitions)
  document.addEventListener("astro:page-load", initStatsAnimation);
</script>
